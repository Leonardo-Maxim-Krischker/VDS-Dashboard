---
title: "BMW Interactive Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: spacelab
knit: (function(inputFile, encoding) { 
      rmarkdown::render(inputFile, 
                        encoding = encoding, 
                        output_file = "index.html") })
---

```{r setup, include=FALSE}
# -----------------------------------------------------------------------------
# 1. SETTINGS & LIBRARIES
# -----------------------------------------------------------------------------
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(flexdashboard)
library(tidyverse)
library(plotly)
library(crosstalk)
library(DT)

# -----------------------------------------------------------------------------
# 2. LOAD & PREPARE DATA
# -----------------------------------------------------------------------------
# Check if sampled data exists, otherwise load full data
if (file.exists("bmw_sales_sampled.csv")) {
  bmw_data <- read_csv("bmw_sales_sampled.csv")
} else {
  bmw_data <- read_csv("BMW sales data (2010-2024).csv")
}

# Clean and format data
bmw_clean <- bmw_data %>%
  distinct() %>%
  mutate(
    Year = as.integer(Year),
    Region = as.factor(Region),
    Fuel_Type = as.factor(Fuel_Type),
    Transmission = as.factor(Transmission),
    Model = as.factor(Model)
  ) %>%
  drop_na() %>%
  # SORT BY YEAR 
  # This ensures the line chart draws smoothly from left to right
  arrange(Year)

# -----------------------------------------------------------------------------
# 3. SHARED DATA (LINKING ENGINE)
# -----------------------------------------------------------------------------
sd <- SharedData$new(bmw_clean)

# Define a color-blind safe blue for single-color charts
safe_blue <- "#0072B2"

```

# Sidebar {.sidebar}

### Filters

```{r}
# --- FILTERS ---
filter_select("region", "Region:", sd, ~Region)
filter_checkbox("fuel", "Fuel Type:", sd, ~Fuel_Type, inline = TRUE)
filter_slider("year", "Year:", sd, ~Year, step = 1, sep = "")
filter_slider("price", "Price (USD):", sd, ~Price_USD)

```

# Row {data-height=600}

### Price vs. Mileage (Color: Fuel Type) {data-width=600}

```{r}
# --- SCATTER PLOT ---
# Using "Dark2" palette for accessibility
plot_ly(sd, x = ~Mileage_KM, y = ~Price_USD, 
        color = ~Fuel_Type, 
        colors = "Dark2", 
        text = ~paste("Model:", Model, 
                      "<br>Year:", Year, 
                      "<br>Price: $", Price_USD),
        hoverinfo = "text",
        type = 'scatter', 
        mode = 'markers',
        height = 550) %>% 
  layout(
    title = "Price vs. Mileage Analysis",
    xaxis = list(title = "Mileage (KM)"),
    yaxis = list(title = "Price (USD)"),
    dragmode = "select",
    
    showlegend = TRUE,
    legend = list(
      itemsizing = "constant" 
    )
  )

```

### Market Insights {data-width=400}

```{r}
# --- CHART 1: Region ---
p1 <- plot_ly(sd, x = ~Region, 
        color = I(safe_blue), 
        stroke = I("white"),
        type = "histogram",
        hovertemplate = "<b>%{x}</b><br>Units: %{y}<extra></extra>") %>%
  layout(
    title = "Sales Volume by Region",
    yaxis = list(title = "Count"),
    xaxis = list(title = ""),
    showlegend = FALSE
  )

# --- CHART 2: Transmission ---
p2 <- plot_ly(sd, x = ~Transmission, 
        color = I(safe_blue), 
        stroke = I("white"),
        type = "histogram",
        hovertemplate = "<b>%{x}</b><br>Units: %{y}<extra></extra>") %>%
  layout(
    title = "Transmission Preference",
    yaxis = list(title = "Count"),
    xaxis = list(title = ""),
    showlegend = FALSE
  )

# --- CHART 3: Yearly Trend (Dynamic Line) ---
p3 <- plot_ly(sd, x = ~Year, y = ~Price_USD, 
        type = 'scatter', 
        mode = 'lines+markers', 
        
        line = list(color = safe_blue, width = 3),
        
        marker = list(color = safe_blue, size = 6), 
        
        hovertemplate = "<b>Year: %{x}</b><br>Sales: %{y}<extra></extra>",
        transforms = list(
          list(
            type = 'aggregate',
            groups = ~Year,
            aggregations = list(
              list(target = 'y', func = 'count', enabled = TRUE)
            )
          )
        )) %>%
  layout(
    title = "Sales Trend (Selection)",
    yaxis = list(title = "Units Sold"),
    xaxis = list(title = "Year", tickformat = "d"),
    showlegend = FALSE
  )

# Stack the 3 charts
subplot(p1, p2, p3, nrows = 3, margin = 0.05, titleY = TRUE)
```
